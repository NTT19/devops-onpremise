---
# ============================================
# FULL CLEANUP
# ============================================
- name: Cleanup Kubernetes Cluster and Jenkins
  hosts: all
  become: yes
  gather_facts: yes
  tasks:
    - name: Display cleanup warning
      debug:
        msg: "⚠️  WARNING: This will completely remove Kubernetes and Jenkins installations!"

- name: Reset Kubernetes on all nodes
  hosts: k8s_cluster
  become: yes
  gather_facts: no
  tasks:
    - name: Reset Kubernetes cluster
      shell: kubeadm reset -f
      ignore_errors: yes

    - name: Remove Kubernetes packages
      apt:
        name:
          - kubeadm
          - kubelet
          - kubectl
        state: absent
        purge: yes
      ignore_errors: yes

    - name: Remove Kubernetes directories
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/kubernetes
        - /var/lib/kubelet
        - /var/lib/etcd
        - /etc/cni
        - /opt/cni
        - /var/lib/cni
        - /run/flannel
        - /etc/systemd/system/kubelet.service.d
        - ~/.kube
      ignore_errors: yes

    - name: Remove CNI network interfaces
      shell: |
        ip link delete cni0 || true
        ip link delete flannel.1 || true
        ip link delete weave || true
      ignore_errors: yes

    - name: Clean iptables rules
      shell: |
        iptables -F
        iptables -t nat -F
        iptables -t mangle -F
        iptables -X
      ignore_errors: yes

    - name: Remove Docker/containerd
      apt:
        name:
          - docker.io
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - containerd
        state: absent
        purge: yes
      ignore_errors: yes

    - name: Remove Docker/containerd directories
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /var/lib/docker
        - /var/lib/containerd
        - /etc/docker
        - /etc/containerd
      ignore_errors: yes

- name: Cleanup Jenkins
  hosts: jenkins
  become: yes
  gather_facts: no
  tasks:
    - name: Stop Jenkins service
      systemd:
        name: jenkins
        state: stopped
      ignore_errors: yes

    - name: Remove Jenkins package
      apt:
        name: jenkins
        state: absent
        purge: yes
      ignore_errors: yes

    - name: Remove Jenkins directories
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /var/lib/jenkins
        - /var/cache/jenkins
        - /var/log/jenkins
        - /etc/default/jenkins
      ignore_errors: yes

    - name: Remove Java
      apt:
        name:
          - openjdk-*-jdk
          - openjdk-*-jre
        state: absent
        purge: yes
      ignore_errors: yes

    - name: Remove Jenkins repository
      file:
        path: /etc/apt/sources.list.d/jenkins.list
        state: absent
      ignore_errors: yes

    - name: Remove Jenkins GPG key
      file:
        path: /usr/share/keyrings/jenkins-keyring.asc
        state: absent
      ignore_errors: yes

- name: Cleanup SQL Server
  hosts: sqlserver
  become: yes
  gather_facts: no
  tasks:
    - name: Stop SQL Server service
      systemd:
        name: mssql-server
        state: stopped
      ignore_errors: yes

    - name: Remove SQL Server packages
      apt:
        name:
          - mssql-server
          - mssql-tools
          - unixodbc-dev
        state: absent
        purge: yes
      ignore_errors: yes

    - name: Remove SQL Server directories
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /var/opt/mssql
        - /opt/mssql
        - /opt/mssql-tools
      ignore_errors: yes

    - name: Remove SQL Server repository
      file:
        path: /etc/apt/sources.list.d/mssql-server.list
        state: absent
      ignore_errors: yes

- name: Final cleanup on all nodes
  hosts: all
  become: yes
  gather_facts: no
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
      ignore_errors: yes

    - name: Autoremove unused packages
      apt:
        autoremove: yes
        purge: yes
      ignore_errors: yes

    - name: Clean apt cache
      apt:
        autoclean: yes
      ignore_errors: yes

    - name: Reboot nodes (optional)
      reboot:
        reboot_timeout: 300
      when: cleanup_reboot | default(false) | bool

- name: Remove local files
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Remove k8s join command file
      file:
        path: "{{ playbook_dir }}/k8s-join-command"
        state: absent
      ignore_errors: yes

    - name: Display completion message
      debug:
        msg: |
          ✅ Cleanup completed!
          
          All components have been removed:
          - Kubernetes cluster (all nodes)
          - Jenkins installation
          - SQL Server installation
          - Docker/containerd
          - Related configurations and data
          
          You can now redeploy using: ./deploy.sh